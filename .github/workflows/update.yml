name: Update CONUS Pressure Zarr

on:
  schedule:
    - cron: "0 * * * *"   # hourly
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: nbm-conus-pressure
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 1

      - name: Ensure Git LFS
        run: git lfs install --local

      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: "1.5.7-0"
          environment-file: environment.yml
          init-shell: bash
          cache-environment: false
          cache-downloads: false
          post-cleanup: none

      - name: Show environment
        shell: bash -l {0}
        run: |
          python -V
          micromamba list | head

      - name: NAM pressure levels -> Zarr (reduced lead time)
        shell: bash -l {0}
        env:
          MODEL: "nam"
          FORECAST_HOURS: "0-18"
          ZARR_PATH: "data/nam_conus_pressure.zarr"
          LOOKBACK_HOURS: "24"
        run: |
          python src/download_pressure_model.py

      - name: Git status
        shell: bash -l {0}
        run: git status

      - name: Commit changes
        shell: bash -l {0}
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update CONUS pressure-level Zarr $(date -u +%Y%m%dT%H00Z)"

      - name: Clean LFS & git objects
        if: always()
        shell: bash -l {0}
        run: |
          git lfs prune --verify-remote || true
          git reflog expire --expire-unreachable=now --all || true
          git gc --prune=now --aggressive || true

      - name: Push
        shell: bash -l {0}
        run: git push origin HEAD:main --force
